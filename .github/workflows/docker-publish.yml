name: Build, Push and Deploy to VM

on:
  push:
    branches: [main]
  workflow_dispatch:  # Permet de déclencher manuellement

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      # Étape 1: Construire l'image Docker
      - name: Build Docker image
        run: docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:latest -t ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:${{ github.sha }} .
      
      # Étape 2: Se connecter à Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      # Étape 3: Pousser l'image sur Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:latest
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/mon-site-flask:${{ github.sha }}
      
      # Étape 4: Déployer sur la VM
      - name: Deploy to Virtual Machine
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "Début du déploiement..."
            # Configuration
            DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
            IMAGE_NAME="mon-site-flask"
            TAG="latest"
            FULL_IMAGE="$DOCKERHUB_USERNAME/$IMAGE_NAME:$TAG"
            CONTAINER_NAME="flask-app"
            
            # Fonctions de logging
            log_info() { echo "[INFO] $1"; }
            log_error() { echo "[ERROR] $1"; }
            log_success() { echo "[SUCCESS] $1"; }
            
            # Créer le répertoire pour l'application
            mkdir -p /opt/flask-app
            
            # Se connecter à Docker Hub
            log_info "Connexion à Docker Hub..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login --username "$DOCKERHUB_USERNAME" --password-stdin
            
            # Vérifier si une mise à jour est nécessaire
            log_info "Vérification des mises à jour..."
            
            # Récupérer le hash de l'image locale
            LOCAL_HASH=$(docker images --digests --format '{{.Digest}}' $FULL_IMAGE 2>/dev/null | head -1)
            
            # Récupérer le hash de l'image sur Docker Hub
            DOCKER_HUB_HASH=$(docker manifest inspect $FULL_IMAGE 2>/dev/null | grep -o '"digest":"[^"]*"' | head -1 | cut -d'"' -f4)
            
            if [ -z "$LOCAL_HASH" ] || [ "$LOCAL_HASH" != "$DOCKER_HUB_HASH" ]; then
                # Télécharger la nouvelle image
                log_info "Téléchargement de la nouvelle image..."
                docker pull $FULL_IMAGE
                
                # Arrêter et supprimer l'ancien conteneur
                log_info "Arrêt de l'ancien conteneur..."
                docker stop $CONTAINER_NAME 2>/dev/null || true
                docker rm $CONTAINER_NAME 2>/dev/null || true
                
                # Supprimer les anciennes images non utilisées
                docker image prune -f
                
                # Créer un réseau Docker si nécessaire
                docker network create flask-network 2>/dev/null || true
                
                # Démarrer le nouveau conteneur
                log_info "Démarrage du nouveau conteneur..."
                docker run -d \
                  --name $CONTAINER_NAME \
                  --restart unless-stopped \
                  --network flask-network \
                  -p 5000:5000 \
                  -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" \
                  -e FLASK_ENV="production" \
                  $FULL_IMAGE
                
                # Attendre que l'application démarre
                sleep 5
                
                # Vérifier le statut du conteneur
                if docker ps | grep -q $CONTAINER_NAME; then
                  log_success "Conteneur démarré avec succès!"
                  
                  # Vérifier la santé de l'application
                  log_info "Vérification de la santé de l'application..."
                  if curl -s --retry 3 --retry-delay 2 http://localhost:5000 > /dev/null; then
                    log_success "Application accessible sur http://localhost:5000"
                    
                    # Récupérer l'IP publique pour le log
                    PUBLIC_IP=$(curl -s http://checkip.amazonaws.com || hostname -I | awk '{print $1}')
                    log_success "Application accessible depuis l'exterieur sur http://$PUBLIC_IP:5000"
                  else
                    log_error "L'application ne répond pas"
                    docker logs $CONTAINER_NAME --tail 20
                  fi
                else
                  log_error "Le conteneur n'a pas démarré"
                  docker logs $CONTAINER_NAME --tail 30
                  exit 1
                fi
            else
                log_info "L'application est déjà à jour"
                log_info "Vérification du statut..."
                
                # Vérifier si le conteneur est en cours d'exécution
                if ! docker ps | grep -q $CONTAINER_NAME; then
                  log_info "Redémarrage du conteneur..."
                  docker start $CONTAINER_NAME 2>/dev/null || docker run -d \
                    --name $CONTAINER_NAME \
                    --restart unless-stopped \
                    -p 5000:5000 \
                    -e SECRET_KEY="${{ secrets.APP_SECRET_KEY }}" \
                    -e FLASK_ENV="production" \
                    $FULL_IMAGE
                fi
            fi
            
            # Nettoyer les images anciennes
            log_info "Nettoyage des images non utilisées..."
            docker image prune -af --filter "until=24h"
            
            log_success "Déploiement terminé!"
            
            # Créer un fichier de log avec le timestamp
            echo "Déployé le $(date) - Commit: ${{ github.sha }}" >> /opt/flask-app/deployment.log